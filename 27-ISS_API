import time
import requests
from datetime import datetime
import smtplib



# 1. Get ISS current position

response = requests.get(url="http://api.open-notify.org/iss-now.json")

## standard response
#print(response) #<Response [200]>

## how to get the default errors
#1xx : Hold On
#2xx : Here You Go
#3xx : No permission
#4xx : The user did something wrong
#5xx : There is something wrong with the server

#print(response.status_code) #200
response.raise_for_status()

## getting the actual data
data = response.json()
#print(data)
#print(data["iss_position"])

iss_longitude = data["iss_position"]["longitude"]
iss_latitude = data["iss_position"]["latitude"]

iss_position = (iss_longitude, iss_latitude)
#print(iss_position)



# 2. Get my sunrise and sunset hours

MY_LAT = 51.507351
MY_LNG = -0.127758

#print(MY_LAT, MY_LNG)

my_lat_range = [MY_LAT-5, MY_LAT+5]
my_lng_range = [MY_LNG-5, MY_LNG+5]

parameters = {
    "lat": MY_LAT,
    "lng": MY_LNG,
    "formatted": 0
}

sun_response = requests.get("https://api.sunrise-sunset.org/json", params=parameters)
sun_response.raise_for_status()
data = sun_response.json()

sunrise = data['results']['sunrise']
sunrise_hour = int(sunrise.split("T")[1].split(":")[0])

sunset = data['results']['sunset']
sunset_hour = int(sunset.split("T")[1].split(":")[0])

hour_now = datetime.now().hour



# 3. My email details

my_email = "test@gmail.com"
password = "randompassword"



# Main function
def check_iss_position():
    if hour_now > sunset_hour or hour_now < sunrise_hour:
        if (my_lat_range[0] <= iss_latitude <= my_lat_range[1]) and (my_lng_range[0] <= iss_longitude <= my_lng_range[1]):
            print("sending email")
            with smtplib.SMTP("smtp.gmail.com") as connection:
                connection.starttls()
                connection.login(user=my_email, password=password)
                connection.sendmail(from_addr=my_email, to_addrs=my_email,
                                     msg="Subject:LOOK UP!\n\nThe ISS is visible now! Can you spot it?")
    else:
        print("Too bright!")


while True:
    check_iss_position()
    print(datetime.now())
    time.sleep(60)
